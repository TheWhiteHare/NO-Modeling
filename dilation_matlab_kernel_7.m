function [dilation] = dilation_matlab_kernel_7(c, t, NO_Mult, stim_duration, NO_sens, basalGC, Hz, radius,pfHgb)
HOME = pwd;
cd('C:\Users\wdh130\Documents\MATLAB-BACKUP\NOFeedbackData')

delay = 6; %kernel size
% delay = 15; %kernel size

if t <= 0
    try
        delete NO_history_temp2.csv
    catch 
    end
else
%dlmwrite('NO_history.csv',[time concentration],'precision','%.4f');
end

dlmwrite('NO_history_temp2.csv',[t c],'-append','precision','%.4f');

if (t-delay)<=0
    dilation = 0;
else
%     A = 6.5; %doesn't matter
%     a1 = 8.91;
%     b1 = 3.7;
%      
% %     A = 6.5; %doesn't matter
% %     a1 = 6;
% %     b1 = 1.2;
% 
%     x = linspace(0,delay,length([-delay:0.01:0]));
%     
%     kernel_g = A.*((x).^(a1-1).*b1.^(a1).*exp(-b1.*(x))./gamma(a1));
%     kernel = kernel_g/sum(kernel_g);
    
    kernel = [[0,5.06697194193869e-18,1.17442927749504e-15,2.79666104158297e-14,2.62322983646560e-13,1.47681348869572e-12,6.01977710385248e-12,1.96363435139111e-11,5.44136709104137e-11,1.33123762125506e-10,2.95208213747201e-10,6.04610493887175e-10,1.15961627380004e-09,2.10481372102099e-09,3.64523570759882e-09,6.06269634679621e-09,9.73428651113668e-09,1.51529480472970e-08,2.29500050621551e-08,3.39194934562031e-08,4.90440971838722e-08,6.95224717271671e-08,9.67977120528323e-08,1.32586703852779e-07,1.78910083027068e-07,2.38122518976067e-07,3.12943032089437e-07,4.06485054581709e-07,5.22285946226694e-07,6.64335682266956e-07,8.37104439490183e-07,1.04556881783790e-06,1.29523644861104e-06,1.59216875603489e-06,1.94300165632557e-06,2.35496399715724e-06,2.83589356027241e-06,3.39425047063486e-06,4.03912787673751e-06,4.78025978821010e-06,5.62802597850292e-06,6.59345388195452e-06,7.68821743580104e-06,8.92463283849058e-06,1.03156512158838e-05,1.18748482064250e-05,1.36164104950468e-05,1.55551193433316e-05,1.77063311802201e-05,2.00859553332618e-05,2.27104289950004e-05,2.55966895325379e-05,2.87621442605975e-05,3.22246378095014e-05,3.60024172293737e-05,4.01140949805947e-05,4.45786099680661e-05,4.94151867832261e-05,5.46432933229998e-05,6.02825969590210e-05,6.63529194335420e-05,7.28741906605140e-05,7.98664016113977e-05,8.73495564654196e-05,9.53436242032531e-05,0.000103868489821543,0.000112943905343350,0.000122589440796518,0.000132824435328246,0.000143667948619768,0.000155138712760146,0.000167255084732750,0.000180034999662101,0.000193495924962491,0.000207654815523118,0.000222528070057557,0.000238131488738159,0.000254480232228550,0.000271588782219827,0.000289470903568316,0.000308139608124964,0.000327607120338568,0.000347884844707191,0.000368983335144267,0.000390912266318073,0.000413680407015557,0.000437295595573886,0.000461764717415599,0.000487093684715914,0.000513287418223602,0.000540349831249888,0.000568283815833062,0.000597091231080003,0.000626772893679509,0.000657328570576318,0.000688756973788908,0.000721055757348697,0.000754221516333001,0.000788249787959195,0.000823135054702847,0.000858870749398206,0.000895449262275361,0.000932861949884585,0.000971099145854851,0.00101015017343029,0.00105000335972542,0.00109064605163734,0.00113206463335056,0.00117424454536826,0.00121717030500164,0.00126082552824761,0.00130519295298362,0.00135025446340746,0.00139599111564867,0.00144238316447799,0.00148941009104045,0.00153705063153777,0.00158528280678551,0.00163408395257068,0.00168343075073598,0.00173329926091698,0.00178366495285985,0.00183450273924747,0.00188578700896313,0.00193749166072205,0.00198959013700214,0.00204205545820693,0.00209486025699483,0.00214797681271078,0.00220137708585777,0.00225503275254747,0.00230891523887130,0.00236299575513477,0.00241724532990012,0.00247163484378435,0.00252613506296150,0.00258071667232043,0.00263535030823117,0.00269000659087537,0.00274465615609824,0.00279926968674164,0.00285381794342029,0.00290827179470503,0.00296260224667923,0.00301678047183700,0.00307077783729321,0.00312456593227846,0.00317811659489326,0.00323140193809852,0.00328439437492095,0.00333706664285446,0.00338939182744016,0.00344134338500980,0.00349289516457937,0.00354402142888124,0.00359469687452532,0.00364489665128104,0.00369459638047426,0.00374377217249424,0.00379240064340789,0.00384045893067982,0.00388792470799827,0.00393477619920847,0.00398099219135622,0.00402655204684618,0.00407143571472004,0.00411562374106157,0.00415909727853628,0.00420183809507467,0.00424382858170921,0.00428505175957589,0.00432549128609243,0.00436513146032592,0.00440395722756352,0.00444195418310064,0.00447910857526181,0.00451540730766988,0.00455083794078012,0.00458538869269619,0.00461904843928529,0.00465180671361069,0.00468365370469981,0.00471458025566684,0.00474457786120865,0.00477363866449374,0.00480175545346353,0.00482892165656600,0.00485513133794159,0.00488037919208149,0.00490466053797858,0.00492797131279115,0.00495030806503984,0.00497166794735797,0.00499204870881561,0.00501144868683736,0.00502986679873419,0.00504730253286902,0.00506375593947601,0.00507922762115311,0.00509371872304732,0.00510723092275180,0.00511976641993394,0.00513132792571295,0.00514191865180547,0.00515154229945732,0.00516020304817930,0.00516790554430437,0.00517465488938360,0.00518045662843750,0.00518531673807942,0.00518924161452689,0.00519223806151681,0.00519431327813962,0.00519547484660765,0.00519573071997193,0.00519508920980168,0.00519355897384033,0.00519114900365119,0.00518786861226572,0.00518372742184695,0.00517873535138002,0.00517290260440148,0.00516623965677864,0.00515875724454958,0.00515046635183446,0.00514137819882781,0.00513150422988154,0.00512085610168766,0.00510944567156957,0.00509728498589005,0.00508438626858403,0.00507076190982359,0.00505642445482222,0.00504138659278528,0.00502566114601280,0.00500926105916075,0.00499219938866636,0.00497448929234263,0.00495614401914710,0.00493717689912933,0.00491760133356128,0.00489743078525450,0.00487667876906763,0.00485535884260758,0.00483348459712703,0.00481106964862119,0.00478812762912589,0.00476467217821909,0.00474071693472773,0.00471627552864105,0.00469136157323205,0.00466598865738760,0.00464017033814829,0.00461392013345825,0.00458725151512534,0.00456017790199168,0.00453271265331429,0.00450486906235557,0.00447666035018290,0.00444809965967673,0.00441920004974600,0.00438997448974999,0.00436043585412511,0.00433059691721527,0.00430047034830423,0.00427006870684807,0.00423940443790604,0.00420848986776766,0.00417733719977394,0.00414595851033053,0.00411436574511035,0.00408257071544330,0.00405058509489038,0.00401842041599973,0.00398608806724166,0.00395359929012000,0.00392096517645682,0.00388819666584755,0.00385530454328355,0.00382229943693892,0.00378919181611864,0.00375599198936466,0.00372271010271692,0.00368935613812588,0.00365593991201345,0.00362247107397889,0.00358895910564655,0.00355541331965181,0.00352184285876218,0.00348825669513008,0.00345466362967384,0.00342107229158371,0.00338749113794943,0.00335392845350607,0.00332039235049463,0.00328689076863428,0.00325343147520277,0.00322002206522168,0.00318666996174337,0.00315338241623618,0.00312016650906479,0.00308702915006242,0.00305397707919171,0.00302101686729117,0.00298815491690401,0.00295539746318630,0.00292275057489136,0.00289022015542749,0.00285781194398584,0.00282553151673577,0.00279338428808451,0.00276137551199855,0.00272951028338368,0.00269779353952125,0.00266623006155753,0.00263482447604391,0.00260358125652502,0.00257250472517240,0.00254159905446100,0.00251086826888632,0.00248031624671944,0.00244994672179785,0.00241976328534962,0.00238976938784863,0.00235996834089875,0.00233036331914468,0.00230095736220749,0.00227175337664256,0.00224275413791821,0.00221396229241284,0.00218538035942871,0.00215701073322063,0.00212885568503756,0.00210091736517556,0.00207319780504023,0.00204569891921707,0.00201842250754819,0.00199137025721364,0.00196454374481615,0.00193794443846746,0.00191157369987519,0.00188543278642858,0.00185952285328204,0.00183384495543500,0.00180840004980708,0.00178318899730715,0.00175821256489541,0.00173347142763713,0.00170896617074722,0.00168469729162451,0.00166066520187476,0.00163687022932160,0.00161331262000437,0.00158999254016209,0.00156691007820274,0.00154406524665711,0.00152145798411644,0.00149908815715320,0.00147695556222429,0.00145505992755614,0.00143340091501097,0.00141197812193386,0.00139079108297986,0.00136983927192091,0.00134912210343180,0.00132863893485510,0.00130838906794435,0.00128837175058530,0.00126858617849483,0.00124903149689717,0.00122970680217723,0.00121061114351069,0.00119174352447068,0.00117310290461074,0.00115468820102400,0.00113649828987824,0.00111853200792690,0.00110078815399566,0.00108326549044478,0.00106596274460677,0.00104887861019968,0.00103201174871570,0.00101536079078513,0.000998924337515799,0.000982700961807753,0.000966689209643410,0.000950887601353121,0.000935294632856214,0.000919908776877609,0.000904728484140040,0.000889752184532044,0.000874978288251747,0.000860405186926643,0.000846031254709434,0.000831854849350126,0.000817874313244479,0.000804087974459035,0.000790494147732843,0.000777091135456103,0.000763877228625886,0.000750850707779164,0.000738009843903321,0.000725352899324391,0.000712878128573217,0.000700583779229783,0.000688468092745927,0.000676529305246700,0.000664765648310591,0.000653175349728893,0.000641756634244442,0.000630507724269991,0.000619426840586499,0.000608512203021587,0.000597762031108414,0.000587174544725284,0.000576747964716224,0.000566480513492833,0.000556370415617654,0.000546415898369387,0.000536615192290194,0.000526966531715395,0.000517468155285832,0.000508118306443198,0.000498915233908600,0.000489857192144668,0.000480942441801461,0.000472169250146492,0.000463535891479137,0.000455040647529719,0.000446681807843564,0.000438457670150282,0.000430366540718598,0.000422406734696982,0.000414576576440383,0.000406874399823324,0.000399298548539653,0.000391847376389226,0.000384519247551790,0.000377312536848334,0.000370225629990197,0.000363256923816183,0.000356404826517965,0.000349667757854024,0.000343044149352403,0.000336532444502521,0.000330131098936323,0.000323838580598984,0.000317653369909461,0.000311573959911115,0.000305598856412652,0.000299726578119626,0.000293955656756757,0.000288284637181277,0.000282712077487560,0.000277236549103252,0.000271856636877132,0.000266570939158932,0.000261378067871336,0.000256276648574371,0.000251265320522404,0.000246342736713972,0.000241507563934628,0.000236758482793029,0.000232094187750457,0.000227513387143972,0.000223014803203394,0.000218597172062308,0.000214259243763273,0.000209999782257425,0.000205817565398653,0.000201711384932536,0.000197680046480197,0.000193722369517264,0.000189837187348097,0.000186023347075447,0.000182279709565718,0.000178605149409972,0.000174998554880852,0.000171458827885570,0.000167984883915099,0.000164575651989727,0.000161230074601116,0.000157947107650993,0.000154725720386634,0.000151564895333244,0.000148463628223391,0.000145420927923608,0.000142435816358294,0.000139507328431027,0.000136634511943424,0.000133816427511649,0.000131052148480690,0.000128340760836520,0.000125681363116240,0.000123073066316315,0.000120514993799012,0.000118006281197129,0.000115546076317114,0.000113133539040684,0.000110767841225017,0.000108448166601615,0.000106173710673933,0.000103943680613849,0.000101757295157059,9.96137844974833e-05,9.75123901807631e-05,9.54523649969110e-05,9.34329728722056e-05,9.14534887603914e-05,8.95131985332579e-05,8.76113988706619e-05,8.57473971500632e-05,8.39205113356344e-05,8.21300698670041e-05,8.03754115476987e-05,7.86558854333342e-05,7.69708507196188e-05,7.53196766302163e-05,7.37017423045249e-05,7.21164366854206e-05,7.05631584070150e-05,6.90413156824714e-05,6.75503261919289e-05,6.60896169705744e-05,6.46586242969068e-05,6.32567935812317e-05,6.18835792544288e-05,6.05384446570262e-05,5.92208619286197e-05,5.79303118976716e-05,5.66662839717206e-05,5.54282760280371e-05,5.42157943047524e-05,5.30283532924935e-05,5.18654756265478e-05,5.07266919795883e-05,4.96115409549833e-05,4.85195689807151e-05,4.74503302039299e-05,4.64033863861433e-05,4.53783067991221e-05,4.43746681214603e-05,4.33920543358699e-05,4.24300566272062e-05,4.14882732812414e-05,4.05663095842045e-05,3.96637777231028e-05,3.87802966868386e-05,3.79154921681349e-05,3.70689964662832e-05,3.62404483907231e-05,3.54294931654684e-05,3.46357823343859e-05,3.38589736673393e-05,3.30987310672053e-05,3.23547244777705e-05,3.16266297925167e-05,3.09141287643005e-05,3.02169089159343e-05,2.95346634516727e-05,2.88670911696109e-05,2.82138963749972e-05,2.75747887944661e-05,2.69494834911910e-05,2.63377007809639e-05,2.57391661492003e-05,2.51536101688731e-05,2.45807684193753e-05,2.40203814063133e-05,2.34721944822301e-05,2.29359577682587e-05,2.24114260767050e-05,2.18983588345587e-05,2.13965200079316e-05,2.09056780274212e-05,2.04256057143969e-05,1.99560802082073e-05,1.94968828943056e-05,1.90477993332890e-05,1.86086191908508e-05,1.81791361686387e-05,1.77591479360181e-05,1.73484560627350e-05,1.69468659524733e-05,1.65541867773031e-05,1.61702314130146e-05,1.57948163753323e-05,1.54277617570045e-05,1.50688911657620e-05,1.47180316631409e-05,1.43750137041636e-05,1.40396710778710e-05,1.37118408487014e-05,1.33913632987075e-05,1.30780818706075e-05,1.27718431116612e-05,1.24724966183664e-05,1.21798949819675e-05,1.18938937347691e-05,1.16143512972493e-05,1.13411289259632e-05]]
    
    NOh = csvread('NO_history_temp2.csv');
    [a, unique_index] = unique(NOh(:,1));
    time = NOh(unique_index,1);
    concentration = NOh(unique_index,2)
    
    concentration_interp = interp1(time',concentration',t + [-delay:0.01:0],'linear','extrap');
    past_c = sum(concentration_interp.*flip(kernel));
    GC_activation = 100/((10^0.95/past_c)^0.8+1);
    GC_activation_baseline = 100/((10^0.95/NOh(1,2))^0.8+1);
    dilation = GC_activation - GC_activation_baseline;
 
% %    
% K = GC_activation_baseline;
% alpha = NO_sens;    
% GC = [0:0.01:100];
% NO_sens_Hill_hold = diff(100*(GC.^alpha)./(K^alpha+GC.^alpha))./0.01; %Hill equation for non-linear relationship between GC activity and vasodilation
% NO_sens_Hill = @(GC_state) interp1(GC(2:end)-0.005,NO_sens_Hill_hold,GC_state);   
% %
    
if abs(dilation*NO_sens) <= 10^-8
    dilation = 0
else
    dilation = round(dilation*NO_sens,8)
end


% if t > (delay)
%         ExtraSignal = 19.25*((t-(delay)).^(a1-1).*b1.^(a1).*exp(-b1.*(t-(delay)))./gamma(a1))
%         dilation = dilation + ExtraSignal*2;
% else
% end


% if t > (delay+9)
%         ExtraSignal = 19.25*((t-(delay+9)).^(a1-1).*b1.^(a1).*exp(-b1.*(t-(delay+9)))./gamma(a1))
%         dilation = dilation + ExtraSignal*2;
% elseif t > (delay)
%         ExtraSignal = 19.25*((t-(delay)).^(a1-1).*b1.^(a1).*exp(-b1.*(t-(delay)))./gamma(a1))
%         dilation = dilation + ExtraSignal*2;
% else
% end

% if t > (delay+basalGC)
% ExtraSignal = 19.25*((t-(delay+basalGC)).^(a1-1).*b1.^(a1).*exp(-b1.*(t-(delay+basalGC)))./gamma(a1))
% dilation = dilation + ExtraSignal*2;
% else
% end
% -eNOS*test(c)*2*pi*r
% -test(c)*nNOS_per*2*pi*r*(1+(rect2(t/tn)*(NO_Mult-1)))
end

fileID = fopen([num2str(NO_Mult) 'NO_' num2str(stim_duration) 'NOd_' num2str(NO_sens) 'NOsens_' num2str(basalGC) 'bGC_' num2str(Hz) 'Hz_' num2str(round(radius*2,1)) 'VD_' '6sNOkernel_GammaWith' num2str(pfHgb) 'Hgb_20_Hct_RawGamma_v13.csv'],'a');
%fileID = fopen([num2str(NO_Mult) 'NO_' num2str(stim_duration) 'NOd_' num2str(NO_sens) 'NOsens_' num2str(basalGC) 'bGC_' num2str(Hz) 'Hz_' num2str(round(radius*2,1)) 'VD_' '6sNOkernel_GammaWith35lowSCD.csv'],'a');
%fileID = fopen([num2str(NO_Mult) 'NO_' num2str(stim_duration) 'NOd_' num2str(NO_sens) 'NOsens_' num2str(basalGC) 'bGC_' num2str(Hz) 'Hz_' num2str(round(radius*2,1)) 'VD_' '6sNOkernel_ExtraPulseNorm60Hgb.csv'],'a');
%fileID = fopen([num2str(NO_Mult) 'NO_' num2str(stim_duration) 'NOd_' num2str(NO_sens) 'NOsens_' num2str(basalGC) 'bGC_' num2str(Hz) 'Hz_' num2str(round(radius*2,1)) 'VD_' '6sNOkernel_GammaBand.csv'],'a');
fprintf(fileID,'%f %f %f\n',[t c dilation]);
fclose(fileID);
cd(HOME)
end
